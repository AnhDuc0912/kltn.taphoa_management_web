import os, csv, uuid, datetime
import io
from flask import Flask, render_template, request, redirect, url_for, flash, send_from_directory
from werkzeug.utils import secure_filename
from db import get_conn
from utils import vn_norm
from flask import Response
from search_routes import bp as search_bp
from flask import send_file
import json, base64, time, mimetypes, requests
from PIL import Image
import re
# --- OpenCLIP 512D text embedding ---
import torch, numpy as np, open_clip, re

CLIP_MODEL_NAME   = os.getenv("EMBED_MODEL", "ViT-B-32")
CLIP_PRETRAINED   = os.getenv("EMBED_PRETRAINED", "laion2b_s34b_b79k")
CLIP_DEVICE       = "cuda" if torch.cuda.is_available() else "cpu"
_clip_model = _clip_tokenizer = None

def get_clip_model():
    global _clip_model, _clip_tokenizer
    if _clip_model is None:
        _clip_model, _, _ = open_clip.create_model_and_transforms(
            CLIP_MODEL_NAME, pretrained=CLIP_PRETRAINED, device=CLIP_DEVICE
        )
        _clip_model.eval()
        _clip_tokenizer = open_clip.get_tokenizer(CLIP_MODEL_NAME)
    return _clip_model, _clip_tokenizer

def embed_text_clip_512(text: str) -> list[float]:
    # chu·∫©n ho√° nh·∫π ƒë·ªÉ ·ªïn ƒë·ªãnh (ƒë√£ c√≥ vn_norm cho search, nh∆∞ng embed gi·ªØ nguy√™n n·ªôi dung)
    t = (text or "").strip()
    if not t:
        return [0.0]*512
    model, tok = get_clip_model()
    with torch.inference_mode():
        tokens = tok([t]).to(CLIP_DEVICE)
        feats  = model.encode_text(tokens)              # [1,512]
        feats  = feats / feats.norm(dim=-1, keepdim=True)
        vec    = feats[0].float().cpu().numpy()
    return vec.tolist()

UPLOAD_DIR = os.path.abspath(os.getenv("UPLOAD_FOLDER", "uploads"))
os.makedirs(UPLOAD_DIR, exist_ok=True)

app = Flask(__name__)
app.secret_key = "dev-secret"
app.register_blueprint(search_bp)

MD_BASE  = os.getenv("MOONDREAM_BASE", "https://api.moondream.ai/v1").rstrip("/")
MD_MODEL = os.getenv("MOONDREAM_MODEL", "moondream-2B")
MD_KEY   = os.getenv("MOONDREAM_API_KEY", "")
MD_MAX_RPM = float(os.getenv("MD_MAX_RPM", "60"))  # ~60 req/ph√∫t
MD_MIN_INTERVAL = max(1.0 / MD_MAX_RPM, 0.016)     # gi√£n c√°ch gi·ªØa 2 requests

VI_SYSTEM = "B·∫°n l√† bi√™n t·∫≠p vi√™n vi·∫øt m√¥ t·∫£ s·∫£n ph·∫©m, CH·ªà d√πng ti·∫øng Vi·ªát."
PROMPT_SEARCH = (
  "Vi·∫øt 1‚Äì2 c√¢u caption b√°n h√†ng, kh√°ch quan, ti·∫øng Vi·ªát. "
  "N·∫øu ƒë·ªçc ƒë∆∞·ª£c t√™n th∆∞∆°ng hi·ªáu/lo·∫°i tr√™n bao b√¨ th√¨ ghi CH√çNH X√ÅC. "
  "Kh√¥ng th√™m emoji hay k√Ω hi·ªáu."
)
PROMPT_SEO = (
  "Vi·∫øt m√¥ t·∫£ 3‚Äì5 c√¢u b·∫±ng ti·∫øng Vi·ªát cho trang s·∫£n ph·∫©m. "
  "Nh·∫•n m·∫°nh c√¥ng d·ª•ng/ƒë·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t; n·∫øu th·∫•y th∆∞∆°ng hi·ªáu/bi·∫øn th·ªÉ/k√≠ch c·ª° th√¨ ghi CH√çNH X√ÅC."
)

VI_CHARS  = r"[ƒÉ√¢ƒë√™√¥∆°∆∞√°√†·∫£√£·∫°·∫•·∫ß·∫©·∫´·∫≠·∫Ø·∫±·∫≥·∫µ·∫∑√©√®·∫ª·∫Ω·∫π·∫ø·ªÅ·ªÉ·ªÖ·ªá√≠√¨·ªâƒ©·ªã√≥√≤·ªè√µ·ªç·ªë·ªì·ªï·ªó·ªô·ªõ·ªù·ªü·ª°·ª£√∫√π·ªß≈©·ª•·ª©·ª´·ª≠·ªØ·ª±√Ω·ª≥·ª∑·ªπ·ªµ]"


def _prepare_image_for_api(img_bytes: bytes):
    """Resize + convert sang JPEG (‚â§1280px, q=85) ƒë·ªÉ payload g·ªçn, tr√°nh 422."""
    try:
        im = Image.open(io.BytesIO(img_bytes)).convert("RGB")
        w, h = im.size
        max_side = 1280
        if max(w, h) > max_side:
            im.thumbnail((max_side, max_side), Image.LANCZOS)
        buf = io.BytesIO()
        im.save(buf, format="JPEG", quality=85, optimize=True)
        return buf.getvalue(), "image/jpeg"
    except Exception:
        return img_bytes, "image/jpeg"
    
def _mime_from_path(path: str) -> str:
    """
    ƒêo√°n MIME t·ª´ ƒë∆∞·ªùng d·∫´n file; fallback 'image/jpeg' n·∫øu kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c.
    """
    # 1) ƒëo√°n theo mimetypes
    m = mimetypes.guess_type(path)[0]
    if m:
        return m
    # 2) fallback theo ph·∫ßn m·ªü r·ªông
    ext = os.path.splitext(path)[1].lower()
    return {
        ".jpg": "image/jpeg", ".jpeg": "image/jpeg",
        ".png": "image/png",   ".webp": "image/webp",
        ".gif": "image/gif",   ".bmp": "image/bmp",
        ".tif": "image/tiff",  ".tiff": "image/tiff",
    }.get(ext, "image/jpeg")

def _is_vietnamese(t: str) -> bool:
    import re
    return bool(re.search(VI_CHARS, (t or "").lower()))

def md_chat_vision(img_bytes: bytes, mime: str, prompt: str, ocr_text: str | None = None, max_tokens: int | None = None) -> str:
    if not MD_KEY:
        raise RuntimeError("Thi·∫øu MOONDREAM_API_KEY")

    # Chu·∫©n ho√° ·∫£nh ‚Üí JPEG g·ªçn
    img_bytes, mime = _prepare_image_for_api(img_bytes)
    b64 = base64.b64encode(img_bytes).decode()

    # Prompt + OCR
    if ocr_text:
        prompt = f"{prompt}\nVƒÉn b·∫£n OCR: {ocr_text}\nN·∫øu ph√π h·ª£p, d√πng ƒë√∫ng th∆∞∆°ng hi·ªáu/lo·∫°i t·ª´ OCR."
    user_text = prompt + "\nTr·∫£ l·ªùi 100% b·∫±ng ti·∫øng Vi·ªát."

    headers = {
        "Authorization": f"Bearer {MD_KEY}",
        "X-Moondream-Auth": MD_KEY,             # an to√†n h∆°n: g·ª≠i k√®m header ri√™ng c·ªßa Moondream
        "Content-Type": "application/json",
    }
    url = f"{MD_BASE}/chat/completions"
    max_tokens = max_tokens or 200

    # ========== Try #1: OpenAI-style (image_url + data URI) ==========
    payload1 = {
        "model": MD_MODEL,
        "messages": [
            {"role": "system", "content": [ {"type":"text", "text": VI_SYSTEM} ]},
            {"role": "user",   "content": [
                {"type":"image_url", "image_url": {"url": f"data:{mime};base64,{b64}"}},
                {"type":"text", "text": user_text}
            ]},
        ],
        "max_tokens": max_tokens
    }
    try:
        r = requests.post(url, headers=headers, json=payload1, timeout=120)
        if r.status_code == 200:
            out = (r.json().get("choices",[{}])[0].get("message",{}).get("content","") or "").strip()
            if _is_vietnamese(out):
                return out
        else:
            print("[moondream] payload1 error", r.status_code, r.text[:500])
            if r.status_code != 422:
                r.raise_for_status()
    except requests.RequestException as e:
        print("[moondream] payload1 exception:", e)

    # ========== Try #2: Moondream-style (input_text + input_image) ==========
    payload2 = {
        "model": MD_MODEL,
        "messages": [
            {"role": "system", "content": [ {"type":"text", "text": VI_SYSTEM} ]},
            {"role": "user",   "content": [
                {"type":"input_text", "text": user_text},
                {"type":"input_image","image": {"data": b64, "mime_type": mime}}
            ]},
        ],
        "max_tokens": max_tokens
    }
    r2 = requests.post(url, headers=headers, json=payload2, timeout=120)
    if r2.status_code != 200:
        print("[moondream] payload2 error", r2.status_code, r2.text[:500])
        r2.raise_for_status()
    out2 = (r2.json().get("choices",[{}])[0].get("message",{}).get("content","") or "").strip()

    # N·∫øu v·∫´n ra ti·∫øng Anh ‚Üí d·ªãch l·∫ßn cu·ªëi (text-only), L∆ØU √ù: content c≈©ng l√† LIST
    if not _is_vietnamese(out2):
        payload_tr = {
            "model": MD_MODEL,
            "messages": [
                {"role": "system", "content": [ {"type":"text","text":"B·∫°n l√† d·ªãch gi·∫£ ti·∫øng Vi·ªát."} ]},
                {"role": "user",   "content": [ {"type":"text","text": "D·ªãch sang ti·∫øng Vi·ªát t·ª± nhi√™n:\n" + out2} ]}
            ],
            "max_tokens": 400
        }
        r3 = requests.post(url, headers=headers, json=payload_tr, timeout=120)
        if r3.status_code == 200:
            out3 = (r3.json().get("choices",[{}])[0].get("message",{}).get("content","") or "").strip()
            if _is_vietnamese(out3):
                return out3
    return out2

# ---------- Helpers ----------
def q(sql, params=None, fetch="all"):
    with get_conn() as conn, conn.cursor() as cur:
        cur.execute(sql, params or [])
        if fetch == "one":
            return cur.fetchone()
        if fetch == "all":
            return cur.fetchall()
        return None

def exec_sql(sql, params=None, returning=False):
    with get_conn() as conn, conn.cursor() as cur:
        cur.execute(sql, params or [])
        if returning:
            return cur.fetchone()
        conn.commit()

# ---------- Static uploads (debug) ----------
@app.route("/uploads/<path:filename>")
def serve_upload(filename):
    return send_from_directory(UPLOAD_DIR, filename)

# Test Search
@app.get("/search/test")
def search_test():
    return render_template("search_test.html", title="Test Search")

#Auto gen description
@app.post("/admin/captions/autogen")
def captions_autogen():
    """
    T·∫°o caption (style='search') + m√¥ t·∫£ (style='seo') cho T·∫§T C·∫¢ ·∫£nh c√≤n thi·∫øu,
    l∆∞u v√†o sku_captions v·ªõi needs_review=TRUE ƒë·ªÉ dev duy·ªát tay.
    H·ªó tr·ª£ tham s·ªë: limit (m·∫∑c ƒë·ªãnh 200), offset (m·∫∑c ƒë·ªãnh 0)
    """
    limit  = int(request.form.get("limit", request.args.get("limit", 200)))
    offset = int(request.form.get("offset", request.args.get("offset", 0)))

    # L·∫•y danh s√°ch ·∫£nh CH∆ØA c√≥ caption 'search' (d·ª±a tr√™n image_path + sku_id)
    rows = q(f"""
        SELECT si.id, si.sku_id, si.image_path, si.ocr_text,
               s.name AS sku_name, s.variant, s.size_text,
               COALESCE(b.name,'') AS brand_name
        FROM sku_images si
        JOIN skus s       ON s.id = si.sku_id
        LEFT JOIN brands b ON b.id = s.brand_id
        LEFT JOIN sku_captions sc
               ON sc.sku_id = si.sku_id
              AND sc.image_path = si.image_path
              AND sc.lang = 'vi'
              AND sc.style = 'search'
        WHERE sc.id IS NULL
        ORDER BY si.sku_id, si.is_primary DESC, si.id
        LIMIT %s OFFSET %s
    """, (limit, offset))

    done, fail = 0, 0
    last_call = 0.0

    for (img_id, sku_id, img_path, ocr_text, sku_name, variant, size_tx, brand_name) in rows:
        try:
            fpath = img_path
            if not os.path.isabs(fpath):
                fpath = os.path.join(UPLOAD_DIR, fpath)
            with open(fpath, "rb") as f:
                img_bytes = f.read()
            mime = _mime_from_path(fpath)

            # Gh√©p OCR v√†o prompt ƒë·ªÉ tƒÉng ch√≠nh x√°c brand/lo·∫°i
            p_search = PROMPT_SEARCH + (f"\nVƒÉn b·∫£n OCR: {ocr_text}" if ocr_text else "")
            p_seo    = PROMPT_SEO    + (f"\nVƒÉn b·∫£n OCR: {ocr_text}" if ocr_text else "")

            # T√¥n tr·ªçng rate limit (‚âà60 rpm m·∫∑c ƒë·ªãnh)
            now = time.time()
            if now - last_call < MD_MIN_INTERVAL:
                time.sleep(MD_MIN_INTERVAL - (now - last_call))

            cap  = md_chat_vision(img_bytes, mime, p_search, ocr_text=ocr_text)
            last_call = time.time()

            # Description (SEO) ‚Äî th√™m gi√£n c√°ch n·∫øu c·∫ßn
            now = time.time()
            if now - last_call < MD_MIN_INTERVAL:
                time.sleep(MD_MIN_INTERVAL - (now - last_call))
            desc = md_chat_vision(img_bytes, mime, p_seo,   ocr_text=ocr_text)
            last_call = time.time()

            # L∆∞u v√†o sku_captions (needs_review = TRUE)
            exec_sql("""
              INSERT INTO sku_captions(sku_id, image_path, lang, style, caption_text,
                                       model_name, prompt_version, needs_review)
              VALUES (%s,%s,'vi','search',%s,%s,'v1.0',TRUE)
              ON CONFLICT (sku_id, image_path, lang, style, model_name, prompt_version) DO UPDATE
              SET caption_text=EXCLUDED.caption_text, needs_review=TRUE
            """, (sku_id, img_path, cap, MD_MODEL))

            exec_sql("""
              INSERT INTO sku_captions(sku_id, image_path, lang, style, caption_text,
                                       model_name, prompt_version, needs_review)
              VALUES (%s,%s,'vi','seo',%s,%s,'v1.0',TRUE)
              ON CONFLICT (sku_id, image_path, lang, style, model_name, prompt_version) DO UPDATE
              SET caption_text=EXCLUDED.caption_text, needs_review=TRUE
            """, (sku_id, img_path, desc, MD_MODEL))

            done += 1

        except Exception as e:
            fail += 1
            # ghi log nh·∫π
            print(f"[autogen] error sku={sku_id} img={img_path}: {e}")

    # refresh corpus ƒë·ªÉ search b·∫Øt k·ªãp (n·∫øu d√πng corpus)
    try:
        exec_sql("SELECT refresh_sku_search_corpus()", returning=True)
    except:
        pass

    # Tr·∫£ UI: quay v·ªÅ trang SKUs v·ªõi th√¥ng b√°o
    flash(f"Autogen xong: th√†nh c√¥ng {done}, l·ªói {fail}", "success" if fail == 0 else "warning")
    return redirect(url_for("skus"))

@app.get("/admin/text-vec/backfill")
def text_vec_backfill():
    limit  = int(request.args.get("limit", 500))
    offset = int(request.args.get("offset", 0))
    rows = q("""
        SELECT id, text FROM sku_texts
        WHERE text_vec IS NULL
        ORDER BY id ASC
        LIMIT %s OFFSET %s
    """, (limit, offset))
    ok = err = 0
    for tid, text in rows:
        try:
            vec = embed_text_clip_512(text)  # list[512]
            exec_sql("UPDATE sku_texts SET text_vec=%s WHERE id=%s", (vec, tid))
            ok += 1
        except Exception as e:
            print("[text-vec] error", tid, e)
            err += 1
    # KN: t·∫°o/ch·∫°y index HNSW 1 l·∫ßn ·ªü DB (ƒë√£ c√≥ trong schema)
    flash(f"Backfill xong: {ok} ok, {err} l·ªói", "success" if err==0 else "warning")
    return redirect(url_for("skus"))


# ---------- Dashboard ----------
@app.get("/")
def dashboard():
    brand_cnt = q("SELECT COUNT(*) FROM brands", fetch="one")[0]
    cat_cnt   = q("SELECT COUNT(*) FROM categories", fetch="one")[0]
    sku_cnt   = q("SELECT COUNT(*) FROM skus", fetch="one")[0]
    img_cnt   = q("SELECT COUNT(*) FROM sku_images", fetch="one")[0]
    return render_template("dashboard.html",
                           brand_cnt=brand_cnt, cat_cnt=cat_cnt, sku_cnt=sku_cnt, img_cnt=img_cnt)

# ----------- Download sample--------------
@app.get("/import/sample")
def import_csv_sample():
    sample = io.StringIO()
    sample.write("brand,category,name,variant,size_text,barcode,image_file\n")
    sample.write("H·∫£o H·∫£o,M√¨ g√≥i,M√¨ H·∫£o H·∫£o,T√¥m chua cay,75g,8934567890123,/path/to/haohao_75g.jpg\n")
    sample.write("Omachi,M√¨ g√≥i,M√¨ Omachi,B√≤ h·∫ßm,80g,8934567890456,/path/to/omachi_bo_80g.jpg\n")
    sample.write("Vinamilk,S·ªØa,S·ªØa Vinamilk,Kh√¥ng ƒë∆∞·ªùng,180ml,8934567890789,/path/to/vinamilk_khongduong.jpg\n")
    sample.seek(0)

    return Response(
        sample.getvalue(),
        mimetype="text/csv",
        headers={"Content-Disposition": "attachment;filename=sample_import.csv"}
    )

# ---------- Brands ----------
@app.get("/brands")
def brands():
    rows = q("SELECT id, name FROM brands ORDER BY name")
    return render_template("brands.html", rows=rows)

@app.post("/brands")
def brand_create():
    name = request.form.get("name","").strip()
    if not name:
        flash("T√™n brand kh√¥ng ƒë∆∞·ª£c r·ªóng","danger")
        return redirect(url_for("brands"))
    try:
        exec_sql("INSERT INTO brands(name) VALUES(%s) ON CONFLICT(name) DO NOTHING", (name,))
        flash("ƒê√£ th√™m brand","success")
    except Exception as e:
        flash(f"L·ªói: {e}","danger")
    return redirect(url_for("brands"))

@app.post("/brands/<int:bid>/delete")
def brand_delete(bid):
    try:
        exec_sql("DELETE FROM brands WHERE id=%s", (bid,))
        flash("ƒê√£ xo√° brand","success")
    except Exception as e:
        flash(f"L·ªói: {e}","danger")
    return redirect(url_for("brands"))

# ---------- Categories ----------
@app.get("/categories")
def categories():
    rows = q("SELECT id, name, parent_id FROM categories ORDER BY name")
    return render_template("categories.html", rows=rows)

@app.post("/categories")
def category_create():
    name = request.form.get("name","").strip()
    parent_id = request.form.get("parent_id") or None
    try:
        exec_sql("INSERT INTO categories(name, parent_id) VALUES(%s,%s)", (name, parent_id))
        flash("ƒê√£ th√™m category","success")
    except Exception as e:
        flash(f"L·ªói: {e}","danger")
    return redirect(url_for("categories"))

@app.post("/categories/<int:cid>/delete")
def category_delete(cid):
    try:
        exec_sql("DELETE FROM categories WHERE id=%s", (cid,))
        flash("ƒê√£ xo√° category","success")
    except Exception as e:
        flash(f"L·ªói: {e}","danger")
    return redirect(url_for("categories"))

# ---------- SKUs ----------
@app.get("/skus")
def skus():
    # l·ªçc theo brand/category/search
    brand_id = request.args.get("brand_id")
    cat_id   = request.args.get("category_id")
    qtext    = (request.args.get("q") or "").strip()

    sql = """
    SELECT s.id, s.name, s.variant, s.size_text, b.name AS brand, c.name AS cat, s.barcode, s.is_active,
           (SELECT image_path FROM sku_images WHERE sku_id=s.id AND is_primary IS TRUE LIMIT 1) AS cover
    FROM skus s
    LEFT JOIN brands b ON b.id=s.brand_id
    LEFT JOIN categories c ON c.id=s.category_id
    WHERE 1=1
    """
    params = []
    if brand_id: sql += " AND s.brand_id=%s"; params.append(brand_id)
    if cat_id:   sql += " AND s.category_id=%s"; params.append(cat_id)
    if qtext:
        sql += " AND EXISTS (SELECT 1 FROM sku_texts st WHERE st.sku_id=s.id AND st.text ILIKE %s)"
        params.append(f"%{vn_norm(qtext)}%")

    sql += """
    AND EXISTS (
    SELECT 1 FROM sku_search_corpus c
    WHERE c.sku_id = s.id
        AND (
        c.tsv @@ plainto_tsquery('simple', %s)
        OR c.normalized_text ILIKE %s
        )
    )
    """
    params.extend([vn_norm(qtext), f"%{vn_norm(qtext)}%"])

    rows = q(sql, params)
    brands = q("SELECT id, name FROM brands ORDER BY name")
    cats   = q("SELECT id, name FROM categories ORDER BY name")
    captions_map = {}
    facets_map = {}
    colors_map = {}
    # provide flags for template to avoid using globals()
    has_refresh_corpus = "refresh_corpus" in app.view_functions
    has_sku_texts = "sku_texts" in app.view_functions

    return render_template(
        "skus.html",
        rows=rows,
        brands=brands,
        cats=cats,
        sel_brand=brand_id,
        sel_cat=cat_id,
        qtext=qtext,
        captions_map=captions_map,
        facets_map=facets_map,
        colors_map=colors_map,
        has_refresh_corpus=has_refresh_corpus,
        has_sku_texts=has_sku_texts,
    )

@app.get("/skus/new")
def sku_new():
    brands = q("SELECT id, name FROM brands ORDER BY name")
    cats   = q("SELECT id, name FROM categories ORDER BY name")
    return render_template("sku_form.html", sku=None, brands=brands, cats=cats)

@app.post("/admin/search-corpus/refresh")
def refresh_corpus():
    exec_sql("SELECT refresh_sku_search_corpus()", returning=True)
    return {"ok": True}

@app.post("/skus")
def sku_create():
    brand_id = request.form.get("brand_id") or None
    cat_id   = request.form.get("category_id") or None
    name     = request.form.get("name","").strip()
    variant  = request.form.get("variant") or None
    size_tx  = request.form.get("size_text") or None
    barcode  = request.form.get("barcode") or None
    active   = True if request.form.get("is_active")=="1" else False
    if not name:
        flash("T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c r·ªóng","danger")
        return redirect(url_for("sku_new"))

    row = exec_sql("""
      INSERT INTO skus(brand_id,category_id,name,variant,size_text,barcode,is_active)
      VALUES(%s,%s,%s,%s,%s,%s,%s)
      RETURNING id
    """, (brand_id,cat_id,name,variant,size_tx,barcode,active), returning=True)
    sku_id = row[0]

    # T·∫°o sku_text chu·∫©n ho√° ƒë·ªÉ search sau n√†y (vector c√≥ th·ªÉ NULL)
    norm_text = vn_norm(" ".join([request.form.get("brand_name",""), name, variant or "", size_tx or ""]))
    exec_sql("INSERT INTO sku_texts(sku_id,text) VALUES(%s,%s) ON CONFLICT DO NOTHING", (sku_id, norm_text))

    flash("ƒê√£ t·∫°o SKU","success")
    return redirect(url_for("sku_edit", sku_id=sku_id))

@app.get("/skus/<int:sku_id>/edit")
def sku_edit(sku_id):
    sku = q("SELECT id,brand_id,category_id,name,variant,size_text,barcode,is_active FROM skus WHERE id=%s", (sku_id,), fetch="one")
    if not sku:
        flash("Kh√¥ng t√¨m th·∫•y SKU","danger")
        return redirect(url_for("skus"))
    brands = q("SELECT id, name FROM brands ORDER BY name")
    cats   = q("SELECT id, name FROM categories ORDER BY name")
    return render_template("sku_form.html", sku=sku, brands=brands, cats=cats)

@app.post("/skus/<int:sku_id>")
def sku_update(sku_id):
    brand_id = request.form.get("brand_id") or None
    cat_id   = request.form.get("category_id") or None
    name     = request.form.get("name","").strip()
    variant  = request.form.get("variant") or None
    size_tx  = request.form.get("size_text") or None
    barcode  = request.form.get("barcode") or None
    active   = True if request.form.get("is_active")=="1" else False
    if not name:
        flash("T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c r·ªóng","danger")
        return redirect(url_for("sku_edit", sku_id=sku_id))

    exec_sql("""
      UPDATE skus SET brand_id=%s, category_id=%s, name=%s, variant=%s, size_text=%s, barcode=%s,
                      is_active=%s, updated_at=%s
      WHERE id=%s
    """, (brand_id,cat_id,name,variant,size_tx,barcode,active,datetime.datetime.utcnow(),sku_id))

    # c·∫≠p nh·∫≠t sku_text chu·∫©n ho√°
    brand_name = q("SELECT name FROM brands WHERE id=%s", (brand_id,), fetch="one")
    brand_name = brand_name[0] if brand_name else ""
    norm_text  = vn_norm(" ".join([brand_name, name, variant or "", size_tx or ""]))
    # n·∫øu ƒë√£ c√≥ th√¨ update, kh√¥ng c√≥ th√¨ insert
    existing = q("SELECT id FROM sku_texts WHERE sku_id=%s LIMIT 1", (sku_id,), fetch="one")
    if existing:
        exec_sql("UPDATE sku_texts SET text=%s WHERE id=%s", (norm_text, existing[0]))
    else:
        exec_sql("INSERT INTO sku_texts(sku_id,text) VALUES(%s,%s)", (sku_id, norm_text))

    flash("ƒê√£ c·∫≠p nh·∫≠t SKU","success")
    return redirect(url_for("skus"))

@app.post("/skus/<int:sku_id>/delete")
def sku_delete(sku_id):
    exec_sql("DELETE FROM skus WHERE id=%s", (sku_id,))
    flash("ƒê√£ xo√° SKU","success")
    return redirect(url_for("skus"))

# ---------- SKU Text ----------@app.get("/skus/<int:sku_id>/texts")
@app.get("/skus/<int:sku_id>/texts")
def sku_texts_page(sku_id):
    sku = q("SELECT id,name FROM skus WHERE id=%s", (sku_id,), fetch="one")
    if not sku:
        flash("Kh√¥ng t√¨m th·∫•y SKU","danger")
        return redirect(url_for("skus"))
    rows = q("SELECT id, text FROM sku_texts WHERE sku_id=%s ORDER BY id", (sku_id,))
    return render_template("sku_texts.html", sku=sku, rows=rows)

@app.post("/skus/<int:sku_id>/texts")
def sku_texts_add(sku_id):
    txt = (request.form.get("text") or "").strip()
    if not txt:
        flash("Ch∆∞a nh·∫≠p m√¥ t·∫£","danger")
        return redirect(url_for("sku_texts_page", sku_id=sku_id))
    norm = vn_norm(txt)
    try:
        exec_sql("INSERT INTO sku_texts(sku_id,text) VALUES(%s,%s)", (sku_id, norm))
        flash("ƒê√£ th√™m m√¥ t·∫£","success")
    except Exception as e:
        flash(f"L·ªói: {e}", "danger")
    return redirect(url_for("sku_texts_page", sku_id=sku_id))

@app.post("/skus/<int:sku_id>/texts/<int:text_id>/update")
def sku_texts_update(sku_id, text_id):
    txt = (request.form.get("text") or "").strip()
    if not txt:
        flash("Ch∆∞a nh·∫≠p m√¥ t·∫£","danger")
        return redirect(url_for("sku_texts_page", sku_id=sku_id))
    norm = vn_norm(txt)
    try:
        exec_sql("UPDATE sku_texts SET text=%s WHERE id=%s AND sku_id=%s", (norm, text_id, sku_id))
        flash("ƒê√£ l∆∞u m√¥ t·∫£","success")
    except Exception as e:
        flash(f"L·ªói: {e}", "danger")
    return redirect(url_for("sku_texts_page", sku_id=sku_id))

@app.post("/skus/<int:sku_id>/texts/<int:text_id>/delete")
def sku_texts_delete(sku_id, text_id):
    try:
        exec_sql("DELETE FROM sku_texts WHERE id=%s AND sku_id=%s", (text_id, sku_id))
        flash("ƒê√£ xo√° m√¥ t·∫£","success")
    except Exception as e:
        flash(f"L·ªói: {e}", "danger")
    return redirect(url_for("sku_texts_page", sku_id=sku_id))


# ---------- SKU Images ----------
@app.get("/skus/<int:sku_id>/images")
def sku_images(sku_id):
    sku = q("SELECT id,name FROM skus WHERE id=%s", (sku_id,), fetch="one")
    imgs = q("""SELECT id, image_path, is_primary FROM sku_images
                WHERE sku_id=%s ORDER BY id DESC""", (sku_id,))
    return render_template("sku_images.html", sku=sku, imgs=imgs)

@app.post("/skus/<int:sku_id>/images")
def sku_image_add(sku_id):
    f = request.files.get("image")
    is_primary = True if request.form.get("is_primary") == "1" else False
    if not f:
        flash("Ch∆∞a ch·ªçn ·∫£nh", "danger")
        return redirect(url_for("sku_images", sku_id=sku_id))

    ext = os.path.splitext(f.filename)[1].lower()
    fname = secure_filename(f"{sku_id}_{uuid.uuid4().hex}{ext}")
    fpath = os.path.join(UPLOAD_DIR, fname)
    f.save(fpath)

    # üîë Ch·ªâ l∆∞u t√™n file ho·∫∑c relative path
    db_path = fname  # ho·∫∑c "images/" + fname n·∫øu mu·ªën c√≥ folder con
    print(db_path)
    
    if is_primary:
        exec_sql("UPDATE sku_images SET is_primary=FALSE WHERE sku_id=%s", (sku_id,))
    exec_sql(
        "INSERT INTO sku_images(sku_id,image_path,is_primary) VALUES(%s,%s,%s)",
        (sku_id, db_path, is_primary),
    )

    flash("ƒê√£ th√™m ·∫£nh", "success")
    return redirect(url_for("sku_images", sku_id=sku_id))


@app.post("/skus/<int:sku_id>/images/<int:img_id>/set-primary")
def sku_image_set_primary(sku_id, img_id):
    exec_sql("UPDATE sku_images SET is_primary=FALSE WHERE sku_id=%s", (sku_id,))
    exec_sql("UPDATE sku_images SET is_primary=TRUE WHERE id=%s", (img_id,))
    flash("ƒê√£ ƒë·∫∑t ·∫£nh ch√≠nh","success")
    return redirect(url_for("sku_images", sku_id=sku_id))

@app.post("/skus/<int:sku_id>/images/<int:img_id>/delete")
def sku_image_delete(sku_id, img_id):
    row = q("SELECT image_path FROM sku_images WHERE id=%s", (img_id,), fetch="one")
    if row:
        try:
            os.remove(row[0])
        except: pass
    exec_sql("DELETE FROM sku_images WHERE id=%s", (img_id,))
    flash("ƒê√£ xo√° ·∫£nh","success")
    return redirect(url_for("sku_images", sku_id=sku_id))

# ---------- Import CSV ----------
@app.get("/import")
def import_csv_page():
    brands = q("SELECT id, name FROM brands ORDER BY name")
    cats   = q("SELECT id, name FROM categories ORDER BY name")
    return render_template("import_csv.html", brands=brands, cats=cats)

@app.post("/import")
def import_csv():
    file = request.files.get("file")
    if not file:
        flash("Ch∆∞a ch·ªçn file CSV","danger")
        return redirect(url_for("import_csv_page"))

    reader = csv.DictReader(file.stream.read().decode("utf-8").splitlines())
    rows_added = 0
    for r in reader:
        brand_name = (r.get("brand") or "").strip()
        cat_name   = (r.get("category") or "").strip()
        name       = (r.get("name") or "").strip()
        variant    = (r.get("variant") or "").strip() or None
        size_tx    = (r.get("size_text") or "").strip() or None
        barcode    = (r.get("barcode") or "").strip() or None
        image_file = (r.get("image_file") or "").strip()

        if not name: continue

        # upsert brand/category
        b = exec_sql("INSERT INTO brands(name) VALUES(%s) ON CONFLICT(name) DO UPDATE SET name=EXCLUDED.name RETURNING id", (brand_name,), returning=True) if brand_name else (None,)
        brand_id = b[0] if b else None
        c = exec_sql("INSERT INTO categories(name) VALUES(%s) ON CONFLICT DO NOTHING RETURNING id", (cat_name,), returning=True) if cat_name else (None,)
        cat_id = c[0] if c else None

        # insert sku
        s = exec_sql("""INSERT INTO skus(brand_id,category_id,name,variant,size_text,barcode,is_active)
                        VALUES(%s,%s,%s,%s,%s,%s,TRUE) RETURNING id""",
                     (brand_id,cat_id,name,variant,size_tx,barcode), returning=True)
        sku_id = s[0]

        # text chu·∫©n ho√°
        norm = vn_norm(" ".join([brand_name, name, variant or "", size_tx or ""]))
        exec_sql("INSERT INTO sku_texts(sku_id,text) VALUES(%s,%s)", (sku_id, norm))

        # ·∫£nh (n·∫øu cung c·∫•p ƒë∆∞·ªùng d·∫´n c·ª•c b·ªô)
        if image_file and os.path.exists(image_file):
            # --- trong sku_image_delete(): x√≥a file an to√†n ---
            row = q("SELECT image_path FROM sku_images WHERE id=%s", (img_id,), fetch="one")
            if row and row[0]:
                try:
                    fpath = row[0]
                    if not os.path.isabs(fpath):
                        fpath = os.path.join(UPLOAD_DIR, fpath)
                    os.remove(fpath)
                except:
                    pass
            exec_sql("DELETE FROM sku_images WHERE id=%s", (img_id,))

        rows_added += 1

    flash(f"ƒê√£ nh·∫≠p {rows_added} d√≤ng","success")
    return redirect(url_for("skus"))

@app.post("/captions/suggest")
def captions_suggest():
    data = request.get_json(force=True)
    # required: sku_id, image_path (t√™n file t∆∞∆°ng ƒë·ªëi), caption_text, style, model_name, prompt_version
    exec_sql("""
      INSERT INTO sku_captions(sku_id, image_path, lang, style, caption_text, model_name, prompt_version, needs_review)
      VALUES (%s,%s,'vi',%s,%s,%s,%s,TRUE)
      ON CONFLICT (sku_id, image_path, lang, style, model_name, prompt_version) DO UPDATE
      SET caption_text=EXCLUDED.caption_text, needs_review=TRUE
    """, (
      data["sku_id"], data["image_path"], data["style"], data["caption_text"],
      data["model_name"], data.get("prompt_version","v1.0")
    ))
    return {"ok": True}

@app.post("/captions/<int:caption_id>/label")
def captions_label(caption_id):
    body = request.get_json(force=True)
    is_ok = bool(body.get("is_acceptable", True))
    corrected = (body.get("corrected_text") or "").strip() or None
    notes = body.get("notes")

    exec_sql("""
      INSERT INTO caption_labels(caption_id, is_acceptable, corrected_text, notes)
      VALUES (%s,%s,%s,%s)
    """, (caption_id, is_ok, corrected, notes))

    # sau khi duy·ªát/s·ª≠a, refresh corpus ƒë·ªÉ search b·∫Øt k·ªãp
    try:
        exec_sql("SELECT refresh_sku_search_corpus()", returning=True)
    except:
        pass
    return {"ok": True}

@app.post("/ai/suggest")
def ai_suggest():
    d = request.get_json(force=True)
    exec_sql("""
      INSERT INTO sku_ai_suggestions(sku_id, image_id, model_name, prompt_ver,
                                     brand_suggest, category_suggest, facets_suggest,
                                     confidences, ocr_text_extracted)
      VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s)
      ON CONFLICT (sku_id, image_id, model_name, prompt_ver) DO UPDATE
      SET brand_suggest=EXCLUDED.brand_suggest,
          category_suggest=EXCLUDED.category_suggest,
          facets_suggest=EXCLUDED.facets_suggest,
          confidences=EXCLUDED.confidences,
          ocr_text_extracted=EXCLUDED.ocr_text_extracted
    """, (
      d["sku_id"], d.get("image_id"), d["model_name"], d.get("prompt_ver","v1.0"),
      d.get("brand_suggest"), d.get("category_suggest"), json.dumps(d.get("facets_suggest", {})),
      json.dumps(d.get("confidences", {})), d.get("ocr_text_extracted")
    ))
    return {"ok": True}

@app.post("/skus/<int:sku_id>/images/<int:img_id>/annotate")
def image_annotate(sku_id, img_id):
    d = request.get_json(force=True)
    exec_sql("""
      UPDATE sku_images
      SET colors = COALESCE(%s, colors),
          color_scores = COALESCE(%s, color_scores),
          detected_facets = COALESCE(%s, detected_facets),
          ocr_text = COALESCE(%s, ocr_text)
      WHERE id=%s AND sku_id=%s
    """, (d.get("colors"), json.dumps(d.get("color_scores")),
          json.dumps(d.get("detected_facets")), d.get("ocr_text"), img_id, sku_id))
    return {"ok": True}

@app.post("/skus/<int:sku_id>/facets")
def sku_facets_update(sku_id):
    d = request.get_json(force=True)
    exec_sql("UPDATE skus SET facets = COALESCE(%s, facets) WHERE id=%s", (json.dumps(d.get("facets")), sku_id))
    return {"ok": True}


@app.get("/skus/images/export.csv")
def export_sku_images_csv():
    # Export SKUs that currently have NO sku_captions (vi, style='search')
    rows = q("""
        SELECT s.id, s.name, s.variant, s.size_text,
               COALESCE(b.name,'') AS brand_name,
               COALESCE(c.name,'') AS category_name,
               (SELECT image_path FROM sku_images WHERE sku_id=s.id AND is_primary IS TRUE LIMIT 1) AS cover
        FROM skus s
        LEFT JOIN brands b ON b.id = s.brand_id
        LEFT JOIN categories c ON c.id = s.category_id
        WHERE NOT EXISTS (
            SELECT 1 FROM sku_captions sc
            WHERE sc.sku_id = s.id
              AND sc.lang = 'vi'
              AND sc.style = 'search'
              AND TRIM(sc.caption_text) <> ''
        )
        ORDER BY s.id
    """)

    import os, csv, datetime
    from flask import send_file

    out_dir = os.path.join(os.path.dirname(__file__), "csv_downloads")
    os.makedirs(out_dir, exist_ok=True)

    ts = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    out_path = os.path.join(out_dir, f"skus_no_captions_{ts}.csv")

    app_host = os.getenv("APP_HOST", "").strip().rstrip("/")
    upload_folder = os.getenv("UPLOAD_FOLDER", "uploads").strip().strip("/")
    if app_host:
        prefix = f"{app_host}/{upload_folder}/"
    else:
        prefix = f"/{upload_folder}/"

    with open(out_path, "w", encoding="utf-8-sig", newline="") as f:
        w = csv.writer(f)
        w.writerow(["sku_id", "sku_name", "variant", "size_text", "brand", "category", "cover_url"])
        for sku_id, sku_name, variant, size_text, brand_name, category_name, cover in rows:
            cover_url = (prefix + cover) if cover else ""
            w.writerow([
                sku_id,
                sku_name,
                variant or "",
                size_text or "",
                brand_name,
                category_name,
                cover_url
            ])

    return send_file(out_path, mimetype="text/csv", as_attachment=True)


@app.get("/skus/captions/export.csv")
def export_captions_csv():
    rows = q("""
        SELECT si.image_path,
               sc.caption_text,
               s.id AS sku_id,
               s.name AS sku_name,
               s.variant,
               s.size_text,
               COALESCE(b.name,'') AS brand_name,
               COALESCE(c.name,'') AS category_name
        FROM sku_captions sc
        JOIN skus s ON s.id = sc.sku_id
        JOIN sku_images si ON si.sku_id = s.id AND si.image_path = sc.image_path
        LEFT JOIN brands b ON b.id = s.brand_id
        LEFT JOIN categories c ON c.id = s.category_id
        WHERE sc.lang = 'vi'
          AND sc.style = 'search'
        ORDER BY s.id
    """)

    import os, csv, datetime
    from flask import send_file

    out_dir = os.path.join(os.path.dirname(__file__), "csv_train")
    os.makedirs(out_dir, exist_ok=True)

    ts = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    out_path = os.path.join(out_dir, f"sku_captions_{ts}.csv")

    with open(out_path, "w", encoding="utf-8-sig", newline="") as f:
        w = csv.writer(f)
        w.writerow([
            "image_path", "caption_text", "sku_id", "sku_name",
            "variant", "size_text", "brand_name", "category_name"
        ])
        for r in rows:
            w.writerow(r)

    return send_file(out_path, mimetype="text/csv", as_attachment=True)

def create_app():
    """
    Compatibility factory used by run.py and other entrypoints.
    Returns the already-configured Flask app instance.
    """
    return app

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
