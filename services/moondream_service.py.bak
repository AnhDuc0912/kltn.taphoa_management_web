# app/services/moondream_service.py
import os, io, base64, time, mimetypes, requests, re
from PIL import Image

MD_BASE  = os.getenv("MOONDREAM_BASE", "https://api.moondream.ai/v1").rstrip("/")
MD_MODEL = os.getenv("MOONDREAM_MODEL", "moondream-2B")
MD_KEY   = os.getenv("MOONDREAM_API_KEY", "")
MD_MAX_RPM = float(os.getenv("MD_MAX_RPM", "60"))
MD_MIN_INTERVAL = max(1.0 / MD_MAX_RPM, 0.016)

VI_SYSTEM = "Bạn là biên tập viên viết mô tả sản phẩm, CHỈ dùng tiếng Việt."
VI_CHARS  = r"[ăâđêôơưáàảãạấầẩẫậắằẳẵặéèẻẽẹếềểễệíìỉĩịóòỏõọốồổỗộớờởỡợúùủũụứừửữựýỳỷỹỵ]"
vi_re = re.compile(VI_CHARS)

def _is_vi(t: str) -> bool:
    return bool(vi_re.search((t or "").lower()))

def _prepare_image_for_api(img_bytes: bytes):
    try:
        im = Image.open(io.BytesIO(img_bytes)).convert("RGB")
        w, h = im.size
        if max(w, h) > 1280:
            im.thumbnail((1280, 1280), Image.LANCZOS)
        buf = io.BytesIO()
        im.save(buf, format="JPEG", quality=85, optimize=True)
        return buf.getvalue(), "image/jpeg"
    except Exception:
        return img_bytes, "image/jpeg"

def _mime_from_path(path: str) -> str:
    m = mimetypes.guess_type(path)[0]
    if m: return m
    ext = os.path.splitext(path)[1].lower()
    return {
        ".jpg": "image/jpeg", ".jpeg": "image/jpeg", ".png": "image/png",
        ".webp":"image/webp", ".gif":"image/gif", ".bmp":"image/bmp",
        ".tif":"image/tiff",  ".tiff":"image/tiff",
    }.get(ext, "image/jpeg")

def md_chat_vision(img_bytes: bytes, mime: str, prompt: str, max_tokens: int | None = None) -> str:
    if not MD_KEY:
        raise RuntimeError("Thiếu MOONDREAM_API_KEY")
    img_bytes, mime = _prepare_image_for_api(img_bytes)
    b64 = base64.b64encode(img_bytes).decode()
    headers = {
        "Authorization": f"Bearer {MD_KEY}",
        "X-Moondream-Auth": MD_KEY,
        "Content-Type": "application/json",
    }
    url = f"{MD_BASE}/chat/completions"
    max_tokens = max_tokens or 200

    # Try 1: OpenAI-style
    payload1 = {
        "model": MD_MODEL,
        "messages": [
            {"role":"system","content":[{"type":"text","text":VI_SYSTEM}]},
            {"role":"user","content":[
                {"type":"image_url","image_url":{"url":f"data:{mime};base64,{b64}"}},
                {"type":"text","text":prompt + "\nTrả lời 100% bằng tiếng Việt."}
            ]}
        ],
        "max_tokens": max_tokens
    }
    try:
        r = requests.post(url, headers=headers, json=payload1, timeout=120)
        if r.status_code == 200:
            out = (r.json().get("choices",[{}])[0].get("message",{}).get("content","") or "").strip()
            if _is_vi(out): return out
    except requests.RequestException:
        pass

    # Try 2: native Moondream
    payload2 = {
        "model": MD_MODEL,
        "messages": [
            {"role":"system","content":[{"type":"text","text":VI_SYSTEM}]},
            {"role":"user","content":[
                {"type":"input_text","text":prompt + "\nTrả lời 100% bằng tiếng Việt."},
                {"type":"input_image","image":{"data":b64,"mime_type":mime}}
            ]}
        ],
        "max_tokens": max_tokens
    }
    r2 = requests.post(url, headers=headers, json=payload2, timeout=120)
    r2.raise_for_status()
    out2 = (r2.json().get("choices",[{}])[0].get("message",{}).get("content","") or "").strip()
    return out2
