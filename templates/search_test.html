{% extends "_base.html" %}
{% block body %}
<div class="card">
  <h1>Test Search</h1>
  <p class="small">Gõ caption (text) hoặc upload ảnh. Kết quả trả về từ API <code>/search/text</code> và
    <code>/search/image</code>.</p>
  <div class="row">
    <div class="col">
      <h2>Search bằng caption</h2>
      <input id="q" type="text" placeholder="vd: mi hao hao tom chua cay 75g" />
      <div style="margin-top:.6rem">
  <button id="btnTextSearch">Tìm text</button>
        <span class="small">Top-k: <input id="k1" type="number" min="1" max="100" value="20"
            style="width:70px;background:#0b1420;border:1px solid #2c3d50;color:#e8eef7;border-radius:8px;padding:.2rem .4rem" /></span>
      </div>
      <div id="textResults"></div>
    </div>
    <div class="col">
      <h2>Search bằng ảnh</h2>
      <input id="file" type="file" accept="image/*" />
      <div style="margin-top:.6rem">
  <button id="btnImageSearch">Tìm ảnh</button>
        <span class="small">Top-k: <input id="k2" type="number" min="1" max="100" value="20"
            style="width:70px;background:#0b1420;border:1px solid #2c3d50;color:#e8eef7;border-radius:8px;padding:.2rem .4rem" /></span>
      </div>
      <div id="imageResults"></div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Raw JSON</h2>
  <pre id="raw"></pre>
</div>

<style>
  .thumb {
    max-width: 80px;
    max-height: 80px;
    object-fit: cover;
  }

  .grid {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .badge {
    background: #007bff;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 3px;
    font-size: 0.8rem;
  }

  .card {
    margin-bottom: 1rem;
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 8px;
  }
</style>

<script>
  window.doTextSearch = async function() {
    const q = document.getElementById('q').value.trim();
    const k = parseInt(document.getElementById('k1').value || '20', 10);
    if (!q) {
      alert('Nhập query');
      return;
    }
    const res = await fetch('/search/text', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        q,
        k
      })
    });
    const data = await res.json();
    document.getElementById('raw').textContent = JSON.stringify(data, null, 2);
    renderTextResults(data.results || [], data.query_id);
  }

  window.doImageSearch = async function() {
    const f = document.getElementById('file').files[0];
    const k = parseInt(document.getElementById('k2').value || '20', 10);
    if (!f) {
      alert('Chọn ảnh');
      return;
    }
    const fd = new FormData();
    fd.append('file', f);
    fd.append('k', String(k));
    const res = await fetch('/search/image', {
      method: 'POST',
      body: fd
    });
    const data = await res.json();
    document.getElementById('raw').textContent = JSON.stringify(data, null, 2);
    renderImageResults(data.results || [], data.query_id);
  }

    // attach event listeners to buttons (safe registration)
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const btnText = document.getElementById('btnTextSearch');
        if (btnText) btnText.addEventListener('click', () => { try { window.doTextSearch(); } catch(e){} });
      } catch (e) {}
      try {
        const btnImg = document.getElementById('btnImageSearch');
        if (btnImg) btnImg.addEventListener('click', () => { try { window.doImageSearch(); } catch(e){} });
      } catch (e) {}
    });

  function el(tag, attrs = {}, children = []) {
    const e = document.createElement(tag);
    for (const k in attrs) {
      if (k === 'class') e.className = attrs[k];
      else if (k.startsWith('on') && typeof attrs[k] === 'function') e.addEventListener(k.substring(2), attrs[k]);
      else e.setAttribute(k, attrs[k]);
    }
    (Array.isArray(children) ? children : [children]).forEach(c => {
      if (typeof c === 'string') e.appendChild(document.createTextNode(c));
      else if (c) e.appendChild(c);
    });
    return e;
  }

  function renderTextResults(items, query_id) {
    const root = document.getElementById('textResults');
    root.innerHTML = '';
    if (items.length === 0) {
      root.textContent = 'Không có kết quả';
      return;
    }
    const table = el('table');
    const thead = el('thead', {}, [el('tr', {}, [
      el('th', {}, 'SKU'),
      el('th', {}, 'Text'),
      el('th', {}, 'Score'),
      el('th', {}, 'Ảnh')
    ])]);
    table.appendChild(thead);
    const tb = el('tbody');
    // record render time for dwell measurement
    window.__search_start_times = window.__search_start_times || {};
    for (const it of items) {
      try {
        window.__search_start_times[query_id + '_' + it.sku_id] = Date.now();
      } catch (e) {}
      const img = el('img', {
        class: 'thumb',
        src: '/uploads/' + (it.image_path || ''),
        alt: ''
      });
      const row = el('tr', {}, [
        el('td', {}, String(it.sku_id)),
        el('td', {}, it.text || ''),
  el('td', {}, (it.score ?? 0).toFixed(4)),
        el('td', {}, img)
      ]);
      // clicking the row records a click event (with dwell time) and opens sku page in new tab
      row.style.cursor = 'pointer';
      row.addEventListener('click', (ev) => {
        ev.preventDefault();
        const key = query_id + '_' + it.sku_id;
        const start = window.__search_start_times && window.__search_start_times[key];
        const dwell = start ? Math.round((Date.now() - start) / 1000) : 0;
        sendCandidateEvent({
          query_id,
          sku_id: it.sku_id,
          action: 'click',
          rank: it.rank,
          dwell_time: dwell,
          re_rank_score: it.re_rank_score
        });
        // open SKU page (adjust URL if your app has a different route)
        try {
          window.open('/skus/' + it.sku_id + '/edit', '_blank');
        } catch (e) {}
      });
      tb.appendChild(row);
    }
    table.appendChild(tb);
    root.appendChild(table);
  }

  function renderImageResults(items, query_id) {
    const root = document.getElementById('imageResults');
    root.innerHTML = '';
    if (items.length === 0) {
      root.textContent = 'Không có kết quả';
      return;
    }
    window.__search_start_times = window.__search_start_times || {};
    for (const it of items) {
      try {
        window.__search_start_times[query_id + '_' + it.sku_id] = Date.now();
      } catch (e) {}
      const card = el('div', {
        class: 'grid card'
      }, [
        el('img', {
          class: 'thumb',
          src: (it.image_path ? '/uploads/' + it.image_path.split('/').pop() : ''),
          alt: ''
        }),
        el('div', {}, [
          el('div', {}, [el('span', {
            class: 'badge'
          }, 'SKU #' + it.sku_id)]),
          el('div', {}, 'score: ' + (it.score ?? 0).toFixed(4)),
          el('div', {
            class: 'small'
          }, it.image_path || '')
        ])
      ]);
      // clicking card records click event and opens SKU
      card.style.cursor = 'pointer';
      card.addEventListener('click', (ev) => {
        ev.preventDefault();
        const key = query_id + '_' + it.sku_id;
        const start = window.__search_start_times && window.__search_start_times[key];
        const dwell = start ? Math.round((Date.now() - start) / 1000) : 0;
        sendCandidateEvent({
          query_id,
          sku_id: it.sku_id,
          action: 'click',
          rank: it.rank,
          dwell_time: dwell,
          re_rank_score: it.re_rank_score
        });
        try {
          window.open('/skus/' + it.sku_id + "/edit", '_blank');
        } catch (e) {}
      });
      root.appendChild(card);
    }
  }

  // send candidate interaction event to server (fire-and-forget)
  function sendCandidateEvent(payload) {
    try {
      fetch('/events/candidate_action', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      }).catch(e => {
        /* ignore network errors */ });
    } catch (e) {}
  }
</script>
{% endblock %}