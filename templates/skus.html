{% extends "_base.html" %}
{% block body %}
<div class="d-flex align-items-center mb-3">
  <h4 class="me-auto">SKUs</h4>
  <div class="d-flex gap-2">
    <!-- Backfill text vectors button -->
    <form method="post" action="{{ url_for('admin_bp.text_vec_backfill') }}"
          onsubmit="return confirm('T·∫°o vector embeddings cho texts ch∆∞a c√≥ vector?')">
      <input type="hidden" name="limit" value="100">
      <button class="btn btn-warning">üìä Backfill Text Vectors</button>
    </form>
    
    <!-- Refresh search corpus button -->
    <form method="post" action="{{ url_for('admin_bp.refresh_search_corpus') }}"
          onsubmit="return confirm('Refresh search corpus?');">
      <button class="btn btn-light">‚Üª L√†m m·ªõi t√¨m ki·∫øm</button>
    </form>
    
    <!-- Admin stats button -->
    <button class="btn btn-secondary" onclick="loadAdminStats()">üìà Th·ªëng k√™</button>
    
    <a class="btn btn-primary" href="{{ url_for('skus_bp.sku_new') }}">+ Th√™m SKU</a>
  </div>
</div>

<!-- Stats display area -->
<div id="admin-stats" class="alert alert-info" style="display: none;"></div>

<form class="row g-2 mb-3">
  <div class="col-auto">
    <select class="form-select" name="brand_id">
      <option value="">-- Brand --</option>
      {% for id,name in brands %}
        <option value="{{ id }}" {{ 'selected' if sel_brand and sel_brand|int==id else '' }}>{{ name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <select class="form-select" name="category_id">
      <option value="">-- Category --</option>
      {% for id,name in cats %}
        <option value="{{ id }}" {{ 'selected' if sel_cat and sel_cat|int==id else '' }}>{{ name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <input class="form-control" name="q" value="{{ qtext or '' }}"
           placeholder="T√¨m t√™n/brand/caption/OCR (BM25 + normalized)">
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-secondary">L·ªçc</button>
  </div>

  <!-- B·ªô l·ªçc n√¢ng cao (optional: facets) -->
  <div class="col-12">
    <a class="small text-decoration-none" data-bs-toggle="collapse" href="#advFilter">B·ªô l·ªçc n√¢ng cao</a>
    <div class="collapse mt-2" id="advFilter">
      <div class="row g-2">
        <div class="col-auto">
          <input class="form-control" name="shape" value="{{ request.args.get('shape','') if request is defined else '' }}" placeholder="shape: triangle/round/...">
        </div>
        <div class="col-auto">
          <input class="form-control" name="packaging" value="{{ request.args.get('packaging','') if request is defined else '' }}" placeholder="packaging: transparent_bag/...">
        </div>
        <div class="col-auto">
          <input class="form-control" name="texture" value="{{ request.args.get('texture','') if request is defined else '' }}" placeholder="texture: crispy/...">
        </div>
        <div class="col-auto">
          <input class="form-control" name="color" value="{{ request.args.get('color','') if request is defined else '' }}" placeholder="color: yellow/golden/...">
        </div>
      </div>
    </div>
  </div>
</form>

<table class="table table-sm align-middle">
  <thead>
    <tr>
      <th>·∫¢nh</th>
      <th>Th√¥ng tin</th>
      <th>Brand/Cat</th>
      <th>Size</th>
      <th>Active</th>
      <th class="text-end">Thao t√°c</th>
    </tr>
  </thead>
  <tbody>
    {# rows: id,name,variant,size_tx,brand,cat,barcode,is_active,cover #}
    {% set captions_map = captions_map|default({}) %}
    {% set facets_map   = facets_map|default({}) %}
    {% set colors_map   = colors_map|default({}) %}
    {% for id, name, variant, size_tx, brand, cat, barcode, is_active, cover in rows %}
      {% set cover_name = (cover|replace('\\','/')).split('/')[-1] if cover else '' %}
      {% set cap = captions_map.get(id) %}
      {% set facets = facets_map.get(id, []) %}
      {% set colors = colors_map.get(id, []) %}
      <tr>
        <td style="width:72px">
          {% if cover_name %}
            <img src="{{ url_for('uploads.serve_upload', filename=cover_name) }}"
                 style="height:56px;object-fit:cover;border-radius:8px">
          {% endif %}
        </td>
        <td style="min-width: 320px">
          <b class="d-block">{{ name }}</b>
          {% if variant %}<div class="text-muted small">{{ variant }}</div>{% endif %}
          {% if barcode %}<div class="text-muted small">Barcode: {{ barcode }}</div>{% endif %}
          {% if cap %}
            <div class="small mt-1" title="{{ cap }}">
              <span class="badge bg-light text-dark me-1">caption</span>
              {{ cap|truncate(80, True, '‚Ä¶') }}
            </div>
          {% endif %}
          {% if facets %}
            <div class="small mt-1">
              {% for f in facets %}
                <span class="badge bg-secondary-subtle border text-dark">{{ f }}</span>
              {% endfor %}
            </div>
          {% endif %}
          {% if colors %}
            <div class="small mt-1">
              {% for c in colors %}
                <span class="badge" style="background:#eee;color:#333">{{ c }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </td>
        <td>
          {{ brand or '' }}
          <div class="text-muted small">{{ cat or '' }}</div>
        </td>
        <td>{{ size_tx or '' }}</td>
        <td>{{ '‚úÖ' if is_active else '‚ùå' }}</td>
        <td class="text-end d-flex gap-1 justify-content-end">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('skus_bp.sku_edit', sku_id=id) }}" title="S·ª≠a SKU">S·ª≠a</a>
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('sku_images_bp.sku_images', sku_id=id) }}" title="Qu·∫£n l√Ω ·∫£nh">·∫¢nh</a>
          <a class="btn btn-sm btn-outline-dark" href="{{ url_for('sku_texts_bp.sku_texts_add', sku_id=id) }}" title="M√¥ t·∫£ chu·∫©n ho√°">M√¥ t·∫£</a>
          <form class="d-inline" method="post" action="{{ url_for('skus_bp.sku_delete', sku_id=id) }}" onsubmit="return confirm('Xo√° SKU?')">
            <button class="btn btn-sm btn-outline-danger">Xo√°</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

<script>
async function loadAdminStats() {
    try {
        const statsDiv = document.getElementById('admin-stats');
        statsDiv.innerHTML = '‚è≥ ƒêang t·∫£i th·ªëng k√™...';
        statsDiv.style.display = 'block';
        
        const response = await fetch('/api/admin/stats');
        const stats = await response.json();
        
        if (response.ok) {
            statsDiv.innerHTML = `
                <strong>üìä Th·ªëng k√™ h·ªá th·ªëng:</strong><br>
                ‚Ä¢ T·ªïng SKUs: <span class="badge bg-primary">${stats.total_skus}</span> (ƒêang ho·∫°t ƒë·ªông: <span class="badge bg-success">${stats.active_skus}</span>)<br>
                ‚Ä¢ Texts c·∫ßn vector: <span class="badge bg-warning">${stats.texts_no_vector}</span><br>
                ‚Ä¢ Images c·∫ßn vector: <span class="badge bg-warning">${stats.images_no_vector}</span><br>
                ‚Ä¢ Search corpus: ${stats.corpus_exists ? 
                    `<span class="badge bg-info">${stats.corpus_entries} entries</span>` : 
                    '<span class="badge bg-danger">Ch∆∞a t·∫°o</span>'
                }
                <button type="button" class="btn-close float-end" onclick="document.getElementById('admin-stats').style.display='none'"></button>
            `;
            statsDiv.className = 'alert alert-info';
        } else {
            statsDiv.innerHTML = `‚ùå L·ªói: ${stats.error}`;
            statsDiv.className = 'alert alert-danger';
        }
    } catch (e) {
        const statsDiv = document.getElementById('admin-stats');
        statsDiv.innerHTML = `‚ùå Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™: ${e.message}`;
        statsDiv.className = 'alert alert-danger';
        statsDiv.style.display = 'block';
    }
}
</script>
